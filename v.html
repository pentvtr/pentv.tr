<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <title>Pen TV Player</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      #video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <video id="video" controls></video>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>
    <script>
      function play(url) {
        const video = document.getElementById("video");

        if (Hls.isSupported()) {
          const hls = new Hls({
            enableWorker: true,
            backBufferLength: 90,
          });

          hls.loadSource(url);
          hls.attachMedia(video);

          hls.on(Hls.Events.ERROR, function (event, data) {
            if (data.fatal) {
              console.error("Hata:", data.type, data.details);
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  hls.recoverMediaError();
                  break;
                default:
                  hls.destroy();
                  break;
              }
            }
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = url;

          video.addEventListener("error", function () {
            console.error("Video hatası:", video.error?.code);
          });
        } else {
          alert("Tarayıcınız bu formatı desteklemiyor");
        }
      }

      function getQueryParams(encoded) {
        if (!encoded) return {};
        const decoded = decodeURIComponent(escape(atob(encoded)));
        return Object.fromEntries(new URLSearchParams(decoded));
      }

      const usp = new URLSearchParams(window.location.search);
      const encoded = usp.get("q");
      const params = getQueryParams(encoded);

      const localEncoded = localStorage.getItem("e");
      const localParams = getQueryParams(localEncoded);

      let l = params.l;
      if (!l) {
        const b = params.b || localParams.b || "";
        const u = params.u || localParams.u || "";
        const p = params.p || localParams.p || "";
        const c = params.c || localParams.c || "2";
        const eParams = { b, u, p, c };
        console.log("e:", eParams);

        const eParamQs = new URLSearchParams(eParams).toString();
        const e = btoa(unescape(encodeURIComponent(eParamQs)));
        localStorage.setItem("e", e);

        if (eParams.b && eParams.u && eParams.p) {
          l = eParams.b + "/live/" + eParams.u + "/" + eParams.p + "/" + eParams.c + ".m3u8";
        }
      }

      if (window.location.search) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      if (l) {
        play(l);
      } else {
        window.location.href = "/s";
      }
    </script>
  </body>
</html>
